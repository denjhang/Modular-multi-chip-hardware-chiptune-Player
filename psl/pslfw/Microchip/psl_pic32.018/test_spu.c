
#include <plib.h>
#include <stdio.h>
#include <string.h>
#include "types.h"
#include "hio.h"
#include "timer2.h"
#include "test.h"

#if __DEBUG
#if 0
//sin 1k, -2.6db, fs=44.1k 3528samples(1764+1764)
const unsigned char sinw[] = {
	//
	0x13,0x02,0x70,0x77,0x77,0x67,0x56,0x34,0x13,0xf1,0xdf,0xcd,0xab,0x9a,0x99,0x99,
	0x13,0x02,0xa9,0xba,0xcc,0xee,0x00,0x31,0x43,0x65,0x76,0x77,0x77,0x67,0x56,0x35,
	0x13,0x02,0x13,0xf1,0xef,0xcc,0xbb,0xa9,0x99,0x98,0x9a,0xab,0xcc,0xee,0x1f,0x21,
	0x13,0x02,0x44,0x55,0x67,0x77,0x77,0x77,0x65,0x44,0x22,0xf1,0xef,0xcd,0xab,0x9a,
	0x13,0x02,0x99,0x99,0xa9,0xba,0xdb,0xed,0x1f,0x21,0x43,0x65,0x76,0x76,0x77,0x77,
	0x13,0x02,0x56,0x35,0x23,0xf1,0xef,0xcd,0xbb,0xa9,0x99,0x99,0x99,0xab,0xcc,0xed,
	0x13,0x02,0x0f,0x22,0x43,0x55,0x76,0x77,0x77,0x67,0x66,0x44,0x23,0x01,0xdf,0xcd,
	0x13,0x02,0xac,0xaa,0x99,0x99,0x99,0xba,0xcb,0xed,0x0f,0x22,0x43,0x64,0x66,0x77,
	0x13,0x02,0x77,0x77,0x56,0x45,0x23,0x01,0xef,0xcd,0xbb,0x9a,0x9a,0x98,0xa9,0xaa,
	0x13,0x02,0xcc,0xed,0x0f,0x21,0x33,0x55,0x76,0x77,0x77,0x67,0x66,0x45,0x23,0x01,
	0x13,0x02,0xef,0xdd,0xbb,0x9a,0x99,0x99,0xa9,0xaa,0xcb,0xed,0x0f,0x11,0x43,0x55,
	0x13,0x02,0x66,0x77,0x77,0x77,0x56,0x45,0x33,0x01,0xef,0xce,0xbb,0xaa,0x99,0x99,
	0x13,0x02,0x99,0xba,0xcb,0xec,0x0f,0x20,0x43,0x54,0x66,0x77,0x77,0x77,0x66,0x45,
	0x13,0x02,0x23,0x02,0xff,0xcd,0xbc,0xaa,0x99,0x99,0x99,0xaa,0xcb,0xdd,0x0f,0x20,
	0x13,0x02,0x33,0x55,0x66,0x77,0x77,0x77,0x66,0x45,0x33,0x01,0xe0,0xce,0xbc,0xaa,
	0x13,0x02,0x99,0x99,0x99,0xaa,0xcb,0xec,0xff,0x11,0x33,0x55,0x75,0x76,0x77,0x77,
	0x13,0x02,0x66,0x45,0x24,0x02,0xe0,0xce,0xbc,0xaa,0x99,0x99,0x99,0xaa,0xcb,0xec,
	0x13,0x02,0x0e,0x20,0x32,0x55,0x75,0x76,0x77,0x77,0x66,0x55,0x33,0x11,0xe0,0xde,
	0x13,0x02,0xbb,0x9b,0x9a,0x99,0x99,0xaa,0xbb,0xdd,0x0e,0x10,0x33,0x54,0x66,0x77,
	0x13,0x02,0x77,0x77,0x66,0x55,0x33,0x02,0xf0,0xdd,0xbc,0x9b,0x9a,0x99,0x99,0xb9,
	0x13,0x02,0xca,0xdc,0xff,0x10,0x33,0x54,0x65,0x77,0x77,0x77,0x66,0x46,0x34,0x11,
	0x13,0x02,0xf0,0xce,0xcc,0xaa,0x99,0x99,0x99,0xaa,0xbb,0xec,0xfe,0x10,0x32,0x54,
	0x13,0x02,0x66,0x76,0x77,0x77,0x67,0x55,0x33,0x12,0xf0,0xde,0xbc,0xab,0x99,0x99,
	0x13,0x02,0x99,0xaa,0xca,0xdc,0xfe,0x10,0x32,0x54,0x65,0x77,0x77,0x77,0x66,0x46,
	0x13,0x02,0x34,0x12,0xf0,0xde,0xcc,0xaa,0x9a,0x99,0x99,0xa9,0xbb,0xdc,0xfe,0x10,
	0x13,0x02,0x32,0x44,0x66,0x76,0x77,0x77,0x67,0x55,0x34,0x12,0xf0,0xee,0xbc,0xab,
	0x13,0x02,0x9a,0x99,0xa8,0xa9,0xca,0xdc,0xfd,0x10,0x32,0x53,0x65,0x67,0x77,0x77,
	0x13,0x02,0x67,0x56,0x34,0x12,0x00,0xde,0xcc,0xab,0xa9,0x98,0x99,0xaa,0xba,0xdc,
	0x13,0x02,0xee,0x10,0x22,0x44,0x66,0x76,0x77,0x77,0x67,0x55,0x44,0x12,0xf1,0xde,
	0x13,0x02,0xbd,0xab,0x9a,0x99,0x99,0xa9,0xca,0xdb,0xee,0x10,0x31,0x53,0x65,0x76,
	0x13,0x02,0x77,0x77,0x67,0x56,0x34,0x13,0x00,0xee,0xcc,0xab,0x9a,0x99,0x99,0xa9,
	0x13,0x02,0xba,0xdc,0xfd,0x1f,0x31,0x53,0x55,0x67,0x77,0x77,0x67,0x56,0x44,0x22,
	0x13,0x02,0x00,0xee,0xcc,0xab,0x9a,0x99,0x99,0xa9,0xba,0xcc,0xee,0x00,0x22,0x53,
	0x13,0x02,0x55,0x67,0x77,0x77,0x67,0x56,0x35,0x13,0x01,0xee,0xbd,0xbb,0xa9,0x99,
	0x13,0x02,0x99,0xa9,0xba,0xdb,0xed,0x00,0x31,0x43,0x65,0x76,0x77,0x77,0x67,0x56,
	0x13,0x02,0x35,0x23,0x00,0xdf,0xcd,0xbb,0xa9,0x99,0x99,0x99,0xab,0xcc,0xfd,0x0f,
	0x13,0x02,0x31,0x43,0x55,0x76,0x77,0x77,0x67,0x66,0x44,0x13,0x01,0xef,0xcc,0xac,
	0x13,0x02,0x9a,0x99,0x99,0xa9,0xba,0xcb,0xee,0x0f,0x21,0x43,0x65,0x66,0x77,0x77,
	0x13,0x02,0x77,0x56,0x35,0x23,0x01,0xef,0xcd,0xbb,0x9a,0x99,0x99,0xa9,0xaa,0xcc,
	0x13,0x02,0xed,0x0f,0x21,0x43,0x55,0x76,0x77,0x77,0x67,0x66,0x44,0x23,0x01,0xef,
	0x13,0x02,0xcd,0xac,0xaa,0x99,0x99,0x99,0xba,0xcb,0xed,0x0f,0x21,0x43,0x64,0x66,
	0x13,0x02,0x77,0x77,0x77,0x56,0x45,0x23,0x01,0xef,0xce,0xbb,0xaa,0x99,0x89,0x9a,
	0x13,0x02,0xaa,0xcc,0xdd,0x0f,0x21,0x33,0x55,0x76,0x76,0x77,0x77,0x66,0x45,0x23,
	0x13,0x02,0x01,0xe0,0xcd,0xbc,0x9a,0x8a,0x99,0xa9,0xaa,0xcb,0xed,0x0e,0x21,0x42,
	0x13,0x02,0x64,0x66,0x77,0x77,0x77,0x56,0x45,0x24,0x11,0xef,0xdd,0xbb,0xaa,0x99,
	0x13,0x02,0x99,0x99,0xaa,0xbc,0xed,0x0e,0x11,0x33,0x55,0x66,0x77,0x77,0x77,0x66,
	0x13,0x02,0x45,0x33,0x01,0xe0,0xce,0xbc,0xaa,0x99,0x99,0x99,0xaa,0xcb,0xdd,0xff,
	0x13,0x02,0x11,0x33,0x55,0x75,0x76,0x77,0x77,0x66,0x45,0x24,0x02,0xe0,0xce,0xbc,
	0x13,0x02,0xaa,0x99,0x99,0x99,0xaa,0xcb,0xec,0x0e,0x20,0x32,0x55,0x75,0x76,0x77,
	0x13,0x02,0x77,0x66,0x55,0x33,0x11,0xe0,0xde,0xbb,0x9b,0x9a,0x99,0x99,0xaa,0xbb,
	0x13,0x02,0xdd,0x0e,0x10,0x33,0x54,0x66,0x77,0x77,0x77,0x66,0x55,0x33,0x02,0xf0,
	0x13,0x02,0xdd,0xbc,0x9b,0x9a,0x99,0x99,0xb9,0xca,0xdc,0xff,0x10,0x33,0x54,0x65,
	0x13,0x02,0x77,0x77,0x77,0x66,0x46,0x34,0x11,0xf0,0xce,0xcc,0xaa,0x99,0x99,0x99,
	0x13,0x02,0xaa,0xbb,0xec,0xfe,0x10,0x32,0x54,0x66,0x76,0x77,0x77,0x67,0x55,0x33,
	0x13,0x02,0x12,0xf0,0xde,0xbc,0xab,0x99,0x99,0x99,0xaa,0xca,0xdc,0xfe,0x10,0x32,
	0x13,0x02,0x54,0x65,0x77,0x77,0x77,0x66,0x46,0x34,0x12,0xf0,0xde,0xcc,0xaa,0x9a,
	0x13,0x02,0x99,0x99,0xa9,0xbb,0xdc,0xfe,0x10,0x32,0x44,0x66,0x76,0x77,0x77,0x67,
	0x13,0x02,0x55,0x34,0x12,0xf0,0xee,0xbc,0xab,0x9a,0x99,0xa8,0xa9,0xca,0xdc,0xfd,
	0x13,0x02,0x10,0x32,0x53,0x65,0x67,0x77,0x77,0x67,0x56,0x34,0x12,0x00,0xde,0xcc,
	0x13,0x02,0xab,0xa9,0x98,0x99,0xaa,0xba,0xdc,0xee,0x10,0x22,0x44,0x66,0x76,0x77,
	0x13,0x02,0x77,0x67,0x55,0x44,0x12,0xf1,0xde,0xbd,0xab,0x9a,0x99,0x99,0xa9,0xca,
	0x13,0x02,0xdb,0xee,0x10,0x31,0x53,0x65,0x76,0x77,0x77,0x67,0x56,0x34,0x13,0x00,
	0x13,0x02,0xee,0xcc,0xab,0x9a,0x99,0x99,0xa9,0xba,0xdc,0xfd,0x1f,0x31,0x53,0x55,
	//	
	0x13,0x06,0x67,0x77,0x77,0x67,0x56,0x44,0x22,0x00,0xee,0xcc,0xab,0x9a,0x99,0x99,
	0x13,0x02,0xa9,0xba,0xcc,0xee,0x00,0x22,0x53,0x55,0x67,0x77,0x77,0x67,0x56,0x35,
	0x13,0x02,0x13,0x01,0xee,0xbd,0xbb,0xa9,0x99,0x99,0xa9,0xba,0xdb,0xed,0x00,0x31,
	0x13,0x02,0x43,0x65,0x76,0x77,0x77,0x67,0x56,0x35,0x23,0x00,0xdf,0xcd,0xbb,0xa9,
	0x13,0x02,0x99,0x99,0x99,0xab,0xcc,0xfd,0x0f,0x31,0x43,0x55,0x76,0x77,0x77,0x67,
	0x13,0x02,0x66,0x44,0x13,0x01,0xef,0xcc,0xac,0x9a,0x99,0x99,0xa9,0xba,0xcb,0xee,
	0x13,0x02,0x0f,0x21,0x43,0x65,0x66,0x77,0x77,0x77,0x56,0x35,0x23,0x01,0xef,0xcd,
	0x13,0x02,0xbb,0x9a,0x99,0x99,0xa9,0xaa,0xcc,0xed,0x0f,0x21,0x43,0x55,0x76,0x77,
	0x13,0x02,0x77,0x67,0x66,0x44,0x23,0x01,0xef,0xcd,0xac,0xaa,0x99,0x99,0x99,0xba,
	0x13,0x02,0xcb,0xed,0x0f,0x21,0x43,0x64,0x66,0x77,0x77,0x77,0x56,0x45,0x23,0x01,
	0x13,0x02,0xef,0xce,0xbb,0xaa,0x99,0x89,0x9a,0xaa,0xcc,0xdd,0x0f,0x21,0x33,0x55,
	0x13,0x02,0x76,0x76,0x77,0x77,0x66,0x45,0x23,0x01,0xe0,0xcd,0xbc,0x9a,0x8a,0x99,
	0x13,0x02,0xa9,0xaa,0xcb,0xed,0x0e,0x21,0x42,0x64,0x66,0x77,0x77,0x77,0x56,0x45,
	0x13,0x02,0x24,0x11,0xef,0xdd,0xbb,0xaa,0x99,0x99,0x99,0xaa,0xbc,0xed,0x0e,0x11,
	0x13,0x02,0x33,0x55,0x66,0x77,0x77,0x77,0x66,0x45,0x33,0x01,0xe0,0xce,0xbc,0xaa,
	0x13,0x02,0x99,0x99,0x99,0xaa,0xcb,0xdd,0xff,0x11,0x33,0x55,0x75,0x76,0x77,0x77,
	0x13,0x02,0x66,0x45,0x24,0x02,0xe0,0xce,0xbc,0xaa,0x99,0x99,0x99,0xaa,0xcb,0xec,
	0x13,0x02,0x0e,0x20,0x32,0x55,0x75,0x76,0x77,0x77,0x66,0x55,0x33,0x11,0xe0,0xde,
	0x13,0x02,0xbb,0x9b,0x9a,0x99,0x99,0xaa,0xbb,0xdd,0x0e,0x10,0x33,0x54,0x66,0x77,
	0x13,0x02,0x77,0x77,0x66,0x55,0x33,0x02,0xf0,0xdd,0xbc,0x9b,0x9a,0x99,0x99,0xb9,
	0x13,0x02,0xca,0xdc,0xff,0x10,0x33,0x54,0x65,0x77,0x77,0x77,0x66,0x46,0x34,0x11,
	0x13,0x02,0xf0,0xce,0xcc,0xaa,0x99,0x99,0x99,0xaa,0xbb,0xec,0xfe,0x10,0x32,0x54,
	0x13,0x02,0x66,0x76,0x77,0x77,0x67,0x55,0x33,0x12,0xf0,0xde,0xbc,0xab,0x99,0x99,
	0x13,0x02,0x99,0xaa,0xca,0xdc,0xfe,0x10,0x32,0x54,0x65,0x77,0x77,0x77,0x66,0x46,
	0x13,0x02,0x34,0x12,0xf0,0xde,0xcc,0xaa,0x9a,0x99,0x99,0xa9,0xbb,0xdc,0xfe,0x10,
	0x13,0x02,0x32,0x44,0x66,0x76,0x77,0x77,0x67,0x55,0x34,0x12,0xf0,0xee,0xbc,0xab,
	0x13,0x02,0x9a,0x99,0xa8,0xa9,0xca,0xdc,0xfd,0x10,0x32,0x53,0x65,0x67,0x77,0x77,
	0x13,0x02,0x67,0x56,0x34,0x12,0x00,0xde,0xcc,0xab,0xa9,0x98,0x99,0xaa,0xba,0xdc,
	0x13,0x02,0xee,0x10,0x22,0x44,0x66,0x76,0x77,0x77,0x67,0x55,0x44,0x12,0xf1,0xde,
	0x13,0x02,0xbd,0xab,0x9a,0x99,0x99,0xa9,0xca,0xdb,0xee,0x10,0x31,0x53,0x65,0x76,
	0x13,0x02,0x77,0x77,0x67,0x56,0x34,0x13,0x00,0xee,0xcc,0xab,0x9a,0x99,0x99,0xa9,
	0x13,0x02,0xba,0xdc,0xfd,0x1f,0x31,0x53,0x55,0x67,0x77,0x77,0x67,0x56,0x44,0x22,
	0x13,0x02,0x00,0xee,0xcc,0xab,0x9a,0x99,0x99,0xa9,0xba,0xcc,0xee,0x00,0x22,0x53,
	0x13,0x02,0x55,0x67,0x77,0x77,0x67,0x56,0x35,0x13,0x01,0xee,0xbd,0xbb,0xa9,0x99,
	0x13,0x02,0x99,0xa9,0xba,0xdb,0xed,0x00,0x31,0x43,0x65,0x76,0x77,0x77,0x67,0x56,
	0x13,0x02,0x35,0x23,0x00,0xdf,0xcd,0xbb,0xa9,0x99,0x99,0x99,0xab,0xcc,0xfd,0x0f,
	0x13,0x02,0x31,0x43,0x55,0x76,0x77,0x77,0x67,0x66,0x44,0x13,0x01,0xef,0xcc,0xac,
	0x13,0x02,0x9a,0x99,0x99,0xa9,0xba,0xcb,0xee,0x0f,0x21,0x43,0x65,0x66,0x77,0x77,
	0x13,0x02,0x77,0x56,0x35,0x23,0x01,0xef,0xcd,0xbb,0x9a,0x99,0x99,0xa9,0xaa,0xcc,
	0x13,0x02,0xed,0x0f,0x21,0x43,0x55,0x76,0x77,0x77,0x67,0x66,0x44,0x23,0x01,0xef,
	0x13,0x02,0xcd,0xac,0xaa,0x99,0x99,0x99,0xba,0xcb,0xed,0x0f,0x21,0x43,0x64,0x66,
	0x13,0x02,0x77,0x77,0x77,0x56,0x45,0x23,0x01,0xef,0xce,0xbb,0xaa,0x99,0x89,0x9a,
	0x13,0x02,0xaa,0xcc,0xdd,0x0f,0x21,0x33,0x55,0x76,0x76,0x77,0x77,0x66,0x45,0x23,
	0x13,0x02,0x01,0xe0,0xcd,0xbc,0x9a,0x8a,0x99,0xa9,0xaa,0xcb,0xed,0x0e,0x21,0x42,
	0x13,0x02,0x64,0x66,0x77,0x77,0x77,0x56,0x45,0x24,0x11,0xef,0xdd,0xbb,0xaa,0x99,
	0x13,0x02,0x99,0x99,0xaa,0xbc,0xed,0x0e,0x11,0x33,0x55,0x66,0x77,0x77,0x77,0x66,
	0x13,0x02,0x45,0x33,0x01,0xe0,0xce,0xbc,0xaa,0x99,0x99,0x99,0xaa,0xcb,0xdd,0xff,
	0x13,0x02,0x11,0x33,0x55,0x75,0x76,0x77,0x77,0x66,0x45,0x24,0x02,0xe0,0xce,0xbc,
	0x13,0x02,0xaa,0x99,0x99,0x99,0xaa,0xcb,0xec,0x0e,0x20,0x32,0x55,0x75,0x76,0x77,
	0x13,0x02,0x77,0x66,0x55,0x33,0x11,0xe0,0xde,0xbb,0x9b,0x9a,0x99,0x99,0xaa,0xbb,
	0x13,0x02,0xdd,0x0e,0x10,0x33,0x54,0x66,0x77,0x77,0x77,0x66,0x55,0x33,0x02,0xf0,
	0x13,0x02,0xdd,0xbc,0x9b,0x9a,0x99,0x99,0xb9,0xca,0xdc,0xff,0x10,0x33,0x54,0x65,
	0x13,0x02,0x77,0x77,0x77,0x66,0x46,0x34,0x11,0xf0,0xce,0xcc,0xaa,0x99,0x99,0x99,
	0x13,0x02,0xaa,0xbb,0xec,0xfe,0x10,0x32,0x54,0x66,0x76,0x77,0x77,0x67,0x55,0x33,
	0x13,0x02,0x12,0xf0,0xde,0xbc,0xab,0x99,0x99,0x99,0xaa,0xca,0xdc,0xfe,0x10,0x32,
	0x13,0x02,0x54,0x65,0x77,0x77,0x77,0x66,0x46,0x34,0x12,0xf0,0xde,0xcc,0xaa,0x9a,
	0x13,0x02,0x99,0x99,0xa9,0xbb,0xdc,0xfe,0x10,0x32,0x44,0x66,0x76,0x77,0x77,0x67,
	0x13,0x02,0x55,0x34,0x12,0xf0,0xee,0xbc,0xab,0x9a,0x99,0xa8,0xa9,0xca,0xdc,0xfd,
	0x13,0x02,0x10,0x32,0x53,0x65,0x67,0x77,0x77,0x67,0x56,0x34,0x12,0x00,0xde,0xcc,
	0x13,0x02,0xab,0xa9,0x98,0x99,0xaa,0xba,0xdc,0xee,0x10,0x22,0x44,0x66,0x76,0x77,
	0x13,0x02,0x77,0x67,0x55,0x44,0x12,0xf1,0xde,0xbd,0xab,0x9a,0x99,0x99,0xa9,0xca,
	0x13,0x02,0xdb,0xee,0x10,0x31,0x53,0x65,0x76,0x77,0x77,0x67,0x56,0x34,0x13,0x00,
	0x13,0x03,0xee,0xcc,0xab,0x9a,0x99,0x99,0xa9,0xba,0xdc,0xfd,0x1f,0x31,0x53,0x55,
};

void WriteSpuFpga(int cs, unsigned int addr, int reg, int data)
{
	int addr2 = addr+((reg>>8)&0xf)*2;
	ChkStatusReg(cs, addr2, 0x80, 0x00);
	//
	WriteIc(cs, addr2, reg&0xff);
	WriteIc(cs, addr2+1, data&0xff);
}

unsigned short ReadSpu(int cs, unsigned int addr, int reg)
{
	WriteSpuFpga(cs, addr, 0x0318, (reg>>1)&0xff);
	int addr2 = addr+((0x318>>8)&0xf)*2;
	ChkStatusReg(cs, addr2, 0x80, 0x00);
	//
#if 1
	unsigned short data = ReadIc(cs, addr+1);
	data <<= 8;
	data |= ReadIc(cs, addr);
#else
	unsigned short data = ReadIc(cs, 1);
	data <<= 8;
	data |= ReadIc(cs, 0);
#endif
	return data;
}

void WriteSpu(int cs, unsigned int addr, int reg, int data)
{
#if 0
	//
	int i;
	for(i=0; i<20; i++){
		unsigned short v = ReadSpu(cs, addr, 0x1ae);
		if((v&0x078c)==0)
			break;
		printf(".$1ae=%04x\n", v);
	}
#endif

#if 1
	reg = 0x200+((reg>>1)&0xff);
	int addr2 = addr+((reg>>8)&0xf)*2;
	ChkStatusReg(cs, addr2, 0x80, 0x00);
	//
	WriteIc(cs, addr2, reg&0xff);
	WriteIc(cs, addr2+1, data&0xff);
	WriteIc(cs, addr2+1, (data>>8)&0xff);
#else
	WriteSpuFpga(cs, addr, 0x302, (reg>>1)&0xff);
	WriteSpuFpga(cs, addr, 0x308, data&0xff);
	WriteSpuFpga(cs, addr, 0x308, (data>>8)&0xff);
#endif
}

//
unsigned int lbuf[1024];	//※512バイト以上確保すること

int SpuTest(char *path)
{
	//
	const int cs = 3, addr = 0;
	const int memlim = 512*1024;
	const int sinwlen = sizeof(sinw)/sizeof(sinw[0]);
	const int panl[16] = { 0x0000, 0x3fff,0x3fff,0x3fff,0x3fff,0x3fff,0x3fff,0x3fff, 0x3fff, 0x1fff,0x0fff,0x07ff,0x03ff,0x01ff,0x00ff,0x007f };
	const int panr[16] = { 0x0000, 0x007f,0x00ff,0x01ff,0x03ff,0x07ff,0x0fff,0x1fff, 0x3fff, 0x3fff,0x3fff,0x3fff,0x3fff,0x3fff,0x3fff,0x3fff };
	//
	int i, j, ext, pan, keyon, sinaddr, coef;
	unsigned short v;
	struct PcKeySence key;

	//
	int fnum = 1;
	char fname[128];
	s32 fh, fs;
	int play = 0, wait, buflen;
	const int lbufs = sizeof(lbuf[0]);
	const int lbuflen = sizeof(lbuf)/lbufs;

	//
	ext = 0;
	pan = 8;
	keyon = 0;
	sinaddr = 0;
	coef = -1;
	while(1){
		//
		if(play==2){
			//
			if(buflen<lbuflen){
				j = lbuflen-buflen;
				if(j>fs)
					j = fs;
				if(j>0){
					PcRead(fh, &lbuf[buflen], j*lbufs);
					fs -= j;
					buflen += j;
					EnableIntT3;
				}
			}	
			//
			unsigned int base = g_dwBaseTime * (44100/TIMER2_FREQ);
			if(base>=wait){
				i = 0;
				while(buflen>0){
					unsigned int cmd = lbuf[i++];
					buflen--;
					if(cmd&0x80000000UL)
						WriteSpu(cs, addr, (cmd>>16)&0x1fe, cmd&0xffff);
					else {
						wait += cmd&0x7fffffffUL;
						base = g_dwBaseTime * (44100/TIMER2_FREQ);
						if(base<wait){
							if(buflen>0)
								memcpy(&lbuf[0], &lbuf[i], buflen*lbufs);
							break;
						}
					}
				}
			}
		}

		//
		PcKeySence(&key);
		if(key.key_code==0x00 || key.key_down==0){
			//入力なし、キー押上
			continue;
		}

		//共通
		int binit = 0, bplay = 0, bfnum = 0, bcoef = 0, bmem = 0, birq = 0, bext = 0, bpan = 0, btoggle = 0;
		switch(key.key_code){
			case 0x1b:	//esc
				if(key.ctrl_state&0x10){
					//shift+esc
					printf(".PcSync\n");
					PcFlush();
					while(1){
						if(PcSync("psl", NULL))
							PcReset();
					}
				}
				return 0;
			case 0x70:	//f1
				//※他アプリ起動用、使用できない
				break;

			case 0x52:	//r
				bpan = +1;
				break;
			case 0x49:	//i
				birq = 1;
				break;
			case 0x50:	//p
				bplay = 1;
				break;
			case 0xc0:	//@
				binit = 1;
				break;

			case 0x41:	//a
				bext = 1;
				break;
			case 0x4c:	//l
				bpan = -1;
				break;

			case 0x42:	//b
				bext = 2;
				break;
			case 0x4d:	//m
				bmem = 1;
				break;

			case 0x20:	//space
				btoggle = 1;
				break;
			case 0x26:	//↑
				bfnum = +1;
				break;
			case 0x25:	//←
				bcoef = -1;
				break;
			case 0x28:	//↓
				bfnum = -1;
				break;
			case 0x27:	//→
				bcoef = +1;
				break;
		}

		//
		if(binit){
			printf(".init\n");
			ResetDevice();
			//
			WriteSpuFpga(cs, addr, 0x0301, 0x90);	//extin+spdif
			WriteSpuFpga(cs, addr, 0x0303, 0x00);	//a9=0
			WriteSpuFpga(cs, addr, 0x0302, 0x00);
			//
			WriteSpu(cs, addr, 0x1aa, 0x8000);
			WriteSpu(cs, addr, 0x1ac, 0x0004);
			//
			WriteSpu(cs, addr, 0x180, 0x3fff);	//main-l
			WriteSpu(cs, addr, 0x182, 0x3fff);	//main-r
			WriteSpu(cs, addr, 0x184, 0x0000);
			WriteSpu(cs, addr, 0x186, 0x0000);
			WriteSpu(cs, addr, 0x188, 0x0000);
			WriteSpu(cs, addr, 0x18a, 0x0000);
			WriteSpu(cs, addr, 0x18c, 0xffff);
			WriteSpu(cs, addr, 0x18e, 0x00ff);
			WriteSpu(cs, addr, 0x190, 0x0000);
			WriteSpu(cs, addr, 0x192, 0x0000);
			WriteSpu(cs, addr, 0x194, 0x0000);
			WriteSpu(cs, addr, 0x196, 0x0000);
			WriteSpu(cs, addr, 0x198, 0x0000);
			WriteSpu(cs, addr, 0x19a, 0x0000);
			WriteSpu(cs, addr, 0x1b0, 0x3fff);	//extina-l
			WriteSpu(cs, addr, 0x1b2, 0x3fff);	//extina-r
			WriteSpu(cs, addr, 0x1b4, 0x3fff);	//extinb-l
			WriteSpu(cs, addr, 0x1b6, 0x3fff);	//extinb-r
			//
			WriteSpu(cs, addr, 0x1a2, 0x0000);
			WriteSpu(cs, addr, 0x1fc, 0x8000);
			WriteSpu(cs, addr, 0x1fe, 0x8000);

			//
			int saddr = 0x01000;
			WriteSpu(cs, addr, 0x1a6, saddr>>3);
			for(i=0; i<8; i++){
				WriteSpu(cs, addr, 0x1a8, 0x0707);
				saddr += 2;
			}
			WriteSpu(cs, addr, 0x1aa, (ReadSpu(cs, addr, 0x1aa)&0xffcf)|0x10);
			WriteSpu(cs, addr, 0x1aa, ReadSpu(cs, addr, 0x1aa)&0xffcf);

			//
			sinaddr = saddr;
			WriteSpu(cs, addr, 0x1a4, saddr>>3);
			WriteSpu(cs, addr, 0x1a6, saddr>>3);
			printf("sinaddr=$%05x, sinwlen=%d\n", sinaddr, sinwlen);
#if 1
			for(i=0; i<sinwlen; i+=2){
				if(i && ((i>>1)&0x1f)==0){
					WriteSpu(cs, addr, 0x1aa, (ReadSpu(cs, addr, 0x1aa)&0xffcf)|0x10);
					WriteSpu(cs, addr, 0x1aa, ReadSpu(cs, addr, 0x1aa)&0xffcf);
				}
				v = sinw[i+1];
				v <<= 8;
				v |= sinw[i];
				if(coef>=0 && (i&0x0f)==0)
					v = (v&0xff0f)|((coef&0xf)<<4);
				WriteSpu(cs, addr, 0x1a8, v);
			}
			WriteSpu(cs, addr, 0x1aa, (ReadSpu(cs, addr, 0x1aa)&0xffcf)|0x10);
			WriteSpu(cs, addr, 0x1aa, ReadSpu(cs, addr, 0x1aa)&0xffcf);
#else
			int p = 0;
			for(i=1; i<=63; i++){
				switch(i){
					case 1:	v = 0x06;	break;
					default:	v = 0x02;	break;
					case 63:	v = 0x03;	break;
				}
				WriteSpu(cs, addr, 0x1a8, (v<<8)|0x00);
				for(j=0; j<28; j+=4){
#define PI	((2*3.1415926535897932384626433832795*1000)/44100)
					double a0l = sin(PI*p)*6.96;	p++;
					double a0h = sin(PI*p)*6.96;	p++;
					double a1l = sin(PI*p)*6.96;	p++;
					double a1h = sin(PI*p)*6.96;	p++;
					int v0l = (a0l<0)?(a0l-0.5):(a0l+0.5);
					int v0h = (a0h<0)?(a0h-0.5):(a0h+0.5);
					int v1l = (a1l<0)?(a1l-0.5):(a1l+0.5);
					int v1h = (a1h<0)?(a1h-0.5):(a1h+0.5);
					v = ((v1h&0xf)<<4)|(v1l&0xf);
					v <<= 8;
					v |= ((v0h&0xf)<<4)|(v0l&0xf);
					WriteSpu(cs, addr, 0x1a8, v);
				}
				WriteSpu(cs, addr, 0x1aa, (ReadSpu(cs, addr, 0x1aa)&0xffcf)|0x10);
				WriteSpu(cs, addr, 0x1aa, ReadSpu(cs, addr, 0x1aa)&0xffcf);
			}
#endif

			//
			WriteSpu(cs, addr, 0x1aa, 0xc040);
		}

		//
		if(bplay){
			play = (play+1)%3;
			switch(play){
				case 0:
					//idle
					break;
				case 1:
					//init
					sprintf(fname, "%s%02d.bin", path, fnum);
					printf(".PcOpen=%s\n", fname);
					fh = PcOpen(fname, PC_RDONLY|PC_BINARY);
					if(fh==-1){
						fs = 0;
						play = 0;
					} else {
						//
						int saddr = 0x01000;
						WriteSpu(cs, addr, 0x1a6, saddr>>3);
						PcLseek(fh, saddr, PC_SEEK_SET);
						for(i=saddr; i<memlim; ){
							unsigned short *p = (void *)lbuf;
							int k = sizeof(lbuf);
							PcRead(fh, lbuf, k);
							k /= sizeof(*p);
							for(j=0; j<k; j++){
								if((i&0x07fff)==0)
									printf("$%05x\n", i);
								if(j && (j&0x1f)==0){
									WriteSpu(cs, addr, 0x1aa, (ReadSpu(cs, addr, 0x1aa)&0xffcf)|0x10);
									WriteSpu(cs, addr, 0x1aa, ReadSpu(cs, addr, 0x1aa)&0xffcf);
								}
								WriteSpu(cs, addr, 0x1a8, p[j]);
								i += 2;
							}
							WriteSpu(cs, addr, 0x1aa, (ReadSpu(cs, addr, 0x1aa)&0xffcf)|0x10);
							WriteSpu(cs, addr, 0x1aa, ReadSpu(cs, addr, 0x1aa)&0xffcf);
						}

						//
						PcLseek(fh, 512*1024, PC_SEEK_SET);
						unsigned short *p = (void *)lbuf;
						PcRead(fh, lbuf, 256*sizeof(*p));

					//	j = 0x1a0;	WriteSpu(cs, addr, j, p[j>>1]);
						j = 0x1a2;	WriteSpu(cs, addr, j, p[j>>1]);
						j = 0x1a4;	WriteSpu(cs, addr, j, p[j>>1]);

						for(j=0x1c0; j<0x200; j+=2)
							WriteSpu(cs, addr, j, p[j>>1]);

//						j = 0x1a6;	WriteSpu(cs, addr, j, p[j>>1]);
//						j = 0x1a8;	WriteSpu(cs, addr, j, p[j>>1]);
						j = 0x1aa;	WriteSpu(cs, addr, j, (ReadSpu(cs, addr, j)&0xc03f)|(p[j>>1]&0x3fc0));
//						j = 0x1ac;	WriteSpu(cs, addr, j, p[j>>1]);
//						j = 0x1ae;	WriteSpu(cs, addr, j, p[j>>1]);

//						j = 0x1b0;	WriteSpu(cs, addr, j, p[j>>1]);
//						j = 0x1b2;	WriteSpu(cs, addr, j, p[j>>1]);
//						j = 0x1b4;	WriteSpu(cs, addr, j, p[j>>1]);
//						j = 0x1b6;	WriteSpu(cs, addr, j, p[j>>1]);
					//	j = 0x1b8;	WriteSpu(cs, addr, j, p[j>>1]);
					//	j = 0x1ba;	WriteSpu(cs, addr, j, p[j>>1]);
					//	j = 0x1bc;	WriteSpu(cs, addr, j, p[j>>1]);
					//	j = 0x1be;	WriteSpu(cs, addr, j, p[j>>1]);

						for(i=0; i<24; i++){
							j = 0x000+i*0x10;	WriteSpu(cs, addr, j, p[j>>1]);
							j = 0x002+i*0x10;	WriteSpu(cs, addr, j, p[j>>1]);
							j = 0x004+i*0x10;	WriteSpu(cs, addr, j, p[j>>1]);
							j = 0x006+i*0x10;	WriteSpu(cs, addr, j, p[j>>1]);
							j = 0x008+i*0x10;	WriteSpu(cs, addr, j, p[j>>1]);
							j = 0x00a+i*0x10;	WriteSpu(cs, addr, j, p[j>>1]);
//							j = 0x00c+i*0x10;	WriteSpu(cs, addr, j, p[j>>1]);
//							j = 0x00e+i*0x10;	WriteSpu(cs, addr, j, p[j>>1]);
						}

						j = 0x190;	WriteSpu(cs, addr, j, p[j>>1]);
						j = 0x192;	WriteSpu(cs, addr, j, p[j>>1]);
						j = 0x194;	WriteSpu(cs, addr, j, p[j>>1]);
						j = 0x196;	WriteSpu(cs, addr, j, p[j>>1]);
						j = 0x198;	WriteSpu(cs, addr, j, p[j>>1]);
						j = 0x19a;	WriteSpu(cs, addr, j, p[j>>1]);
//						j = 0x19c;	WriteSpu(cs, addr, j, p[j>>1]);
//						j = 0x19e;	WriteSpu(cs, addr, j, p[j>>1]);

						j = 0x180;	WriteSpu(cs, addr, j, p[j>>1]);
						j = 0x182;	WriteSpu(cs, addr, j, p[j>>1]);
						j = 0x184;	WriteSpu(cs, addr, j, p[j>>1]);
						j = 0x186;	WriteSpu(cs, addr, j, p[j>>1]);
//						j = 0x188;	WriteSpu(cs, addr, j, p[j>>1]);
//						j = 0x18a;	WriteSpu(cs, addr, j, p[j>>1]);
//						j = 0x18c;	WriteSpu(cs, addr, j, p[j>>1]);
//						j = 0x18e;	WriteSpu(cs, addr, j, p[j>>1]);

						//
						fs = PcLseek(fh, 0, PC_SEEK_END);
						fs -= PcLseek(fh, 512*1024+512, PC_SEEK_SET);
						fs /= lbufs;
						play = 2;
						wait = 0;
						buflen = 0;
						DisableIntT3;
						SetTimer2(pb_clk/(1*TIMER2_FREQ));
					}
					break;
				case 2:
					//play
					break;
				default:
					//stop
					DisableIntT3;
					PcClose(fh);
					fs = 0;
					play = 0;
					break;
			}
			printf(".play=%d\n", play);
		}
		//
		if(bfnum){
			bfnum += fnum;
			if(bfnum<1)
				bfnum = 1;
			else
			if(bfnum>99)
				bfnum = 99;
			if(bfnum!=fnum){
				fnum = bfnum;
				printf(".fnum=%02d\n", fnum);
			}
		}

		//
		if(bcoef){
			bcoef += coef;
			if(bcoef<-1)
				bcoef = -1;
			else
			if(bcoef>4)
				bcoef = 4;
			if(bcoef!=coef){
				coef = bcoef;
				printf(".coef=%d\n", coef);
			}
		}

#if 0
		//
		if(bmem){
			printf(".memory_test_start\n");
			//
			int saddr = 0x00000;
			WriteSpu(cs, addr, 0x1a6, saddr>>3);
			for(i=saddr; i<memlim; i+=2){
				if((i&0x07fff)==0)
					printf("$%05x=$0000\n", i);
				if(i && ((i>>1)&0x1f)==0){
					WriteSpu(cs, addr, 0x1aa, (ReadSpu(cs, addr, 0x1aa)&0xffcf)|0x10);
					WriteSpu(cs, addr, 0x1aa, ReadSpu(cs, addr, 0x1aa)&0xffcf);
				}
				WriteSpu(cs, addr, 0x1a8, 0x0000);
			}
			WriteSpu(cs, addr, 0x1aa, (ReadSpu(cs, addr, 0x1aa)&0xffcf)|0x10);
			WriteSpu(cs, addr, 0x1aa, ReadSpu(cs, addr, 0x1aa)&0xffcf);
				WriteSpu(cs, addr, 0x1a8, 0x1234);
			WriteSpu(cs, addr, 0x1aa, (ReadSpu(cs, addr, 0x1aa)&0xffcf)|0x10);
			WriteSpu(cs, addr, 0x1aa, ReadSpu(cs, addr, 0x1aa)&0xffcf);
			//
			unsigned short d = 0x0000;
			int skip = 0;
			for(i=0x00000; i<memlim; i+=8){
				if((i&0x07fff)==0){
					printf("$%05x\n", i);
					skip = 0;
				}
				//
				if(skip==0){
					unsigned short data[4], data2[4], data3[4];
					WriteSpu(cs, addr, 0x1a6, i>>3);
					for(j=0; j<4; j++){
						WriteSpu(cs, addr, 0x1aa, ReadSpu(cs, addr, 0x1aa)&0xffcf);
						data3[j] = ReadSpu(cs, addr, 0x1a8);
					}
/*					//
					WriteSpu(cs, addr, 0x1a6, i>>3);
					for(j=0; j<4; j++){
						d = (d+3)&0xffff;
						if(d==0)
							d++;
						data[j] = d;
						WriteSpu(cs, addr, 0x1a8, d);
					}
					WriteSpu(cs, addr, 0x1aa, (ReadSpu(cs, addr, 0x1aa)&0xffcf)|0x10);
					WriteSpu(cs, addr, 0x1aa, ReadSpu(cs, addr, 0x1aa)&0xffcf);*/
					//
//					WriteSpu(cs, addr, 0x1a6, i>>3);
					for(j=0; j<4; j++){
#if 0
						data2[j] = ReadSpu(cs, addr, 0x1a8);
						if(data3[j]!=0x0000 || data[j]!=data2[j]){
							printf("$%05x:$0000<>$%04x,$%04x<>$%04x\n", i+j*2, data3[j], data[j], data2[j]);
							skip = 1;
						}
#else
						if(data3[j]!=0x0000){
							printf("$%05x:$0000<>$%04x\n", i+j*2, data3[j]);
							skip = 1;
						}
#endif
					}
				}
			}
			//
			printf(".memory_test_end\n");
		}
#endif

		//
		if(birq){
			printf(".irq, ");
			i = 0x19c;	printf("$%03x:$%04x, ", i, ReadSpu(cs, addr, i));
			i = 0x19e;	printf("$%03x:$%04x, ", i, ReadSpu(cs, addr, i));
			i = 0x1aa;	printf("$%03x:$%04x, ", i, ReadSpu(cs, addr, i));
			i = 0x1ac;	printf("$%03x:$%04x, ", i, ReadSpu(cs, addr, i));
			//
			i = 0x1ae;
			v = ReadSpu(cs, addr, i);
			printf("$%03x:$%04x\n", i, v);
			if(v&0x0040){
				i = 0x1aa;
				unsigned short reg1aa = ReadSpu(cs, addr, i);
				WriteSpu(cs, addr, i, reg1aa&0xffbf);
				if(reg1aa&0x0040)
					WriteSpu(cs, addr, i, reg1aa);
			}
		}

		//
		if(bext){
			ext ^= 1<<(bext-1);
			printf(".ext=%d\n", ext);
			WriteSpu(cs, addr, 0x1aa, (ReadSpu(cs, addr, 0x1aa)&0xfffc)|ext);
		}
		//
		if(bpan){
			bpan += pan;
			if(bpan<0)
				bpan = 0;
			else
			if(bpan>0xf)
				bpan = 0xf;
			if(bpan!=pan){
				pan = bpan;
				int l = panl[pan];
				int r = panr[pan];
				printf(".pan=%d(l=$%04x, r=$%04x)\n", pan, l, r);
				if(keyon){
					WriteSpu(cs, addr, 0x000, l);	//left
					WriteSpu(cs, addr, 0x002, r);	//right
				}
			}
		}
		//
		if(btoggle){
			keyon ^= 1;
			printf(".key%s\n", keyon?"on":"off");
			//
			WriteSpu(cs, addr, 0x180, 0x3fff);	//main-l
			WriteSpu(cs, addr, 0x182, 0x3fff);	//main-r
			WriteSpu(cs, addr, 0x184, 0x0000);
			WriteSpu(cs, addr, 0x186, 0x0000);
			WriteSpu(cs, addr, 0x18c, 0xffff);
			WriteSpu(cs, addr, 0x18e, 0x00ff);
			WriteSpu(cs, addr, 0x190, 0x0000);
			WriteSpu(cs, addr, 0x192, 0x0000);
			WriteSpu(cs, addr, 0x194, 0x0000);
			WriteSpu(cs, addr, 0x196, 0x0000);
			WriteSpu(cs, addr, 0x198, 0x0000);
			WriteSpu(cs, addr, 0x19a, 0x0000);
			WriteSpu(cs, addr, 0x1b0, 0x3fff);	//extina-l
			WriteSpu(cs, addr, 0x1b2, 0x3fff);	//extina-r
			WriteSpu(cs, addr, 0x1b4, 0x3fff);	//extinb-l
			WriteSpu(cs, addr, 0x1b6, 0x3fff);	//extinb-r
			//
			WriteSpu(cs, addr, 0x1a2, 0x0000);
			WriteSpu(cs, addr, 0x1fc, 0x8000);
			WriteSpu(cs, addr, 0x1fe, 0x8000);
			//
			if(keyon){
				//
				WriteSpu(cs, addr, 0x000, panl[pan]);	//left
				WriteSpu(cs, addr, 0x002, panr[pan]);	//right
				WriteSpu(cs, addr, 0x004, 0x1000);
				WriteSpu(cs, addr, 0x006, sinaddr>>3);
				WriteSpu(cs, addr, 0x008, (0x00<<8)|(0x0<<4)|0xf);
				WriteSpu(cs, addr, 0x00a, (0x00<<6)|0x00);
				WriteSpu(cs, addr, 0x188, 0x0001);
				WriteSpu(cs, addr, 0x18a, 0x0000);
			} else {
				//keyoff
			}
		}
	}
}
#endif
#endif
